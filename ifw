#!/bin/bash
#
# rc.firewall-0.17
# Linux/Netfilter firewall script.
#
# (c) 2003 by ingwar
# Distributed under the terms of GNU GPLv2 or later versions.
#
# Files in /etc/firewall:
# 
# if_ext	external interfaces
# if_int	internal interfaces
# if_masq	masqueraded interfaces
# blacklist	blacklisted hosts
# nofw_hard	noforwarded hosts
# nofw_soft	partially noforwarded hosts
# tcp_ok	open TCP ports
# udp_ok	open UDP ports
# tcp_fw	TCP ports, allowed to forward in
# udp_fw	UDP ports, allowed to forward in
# tcp_nofw	TCP ports list for nofw_soft
# udp_nofw	UDP ports list for nofw_soft
#
 
IPTABLES="iptables"
DATE=`date '+%Y%m%d%H%M%S'`
DUMPFILE="/var/log/iptables.dump"

FW_HOME="/etc/firewall"
F_IF_EXT="$FW_HOME/if_ext"
F_IF_INT="$FW_HOME/if_int"
F_IF_MASQ="$FW_HOME/if_masq"
BLACKLIST="$FW_HOME/blacklist"
NOFW_HARD="$FW_HOME/nofw_hard"
NOFW_SOFT="$FW_HOME/nofw_soft"
F_TCP_OK="$FW_HOME/tcp_ok"
F_UDP_OK="$FW_HOME/udp_ok"
F_TCP_FW="$FW_HOME/tcp_fw"
F_UDP_FW="$FW_HOME/udp_fw"
F_TCP_NOFW="$FW_HOME/tcp_nofw"
F_UDP_NOFW="$FW_HOME/udp_nofw"

ERRMSG1="Can not open config file"
ERRMSG2="Empty config file"

mp() {

  if [ -r $F ]; then
    i=1
    for P in `cat $F`; do
      if [ -z $MP ]; then
        MP="$P"
      else
        MP="$MP,$P"
      fi
    done
  else
    echo "$ERRMSG1: $F"
    exit 1
  fi
  if [ -z $MP ]; then
    echo "$ERRMSG2: $F"
    exit 1
  fi

}

firewall_start() {

  if [ -r $F_IF_EXT ]; then
    i=1
    for IF in `cat $F_IF_EXT`; do
      if [ -n $IF ]; then
        IF_EXT[$i]="$IF"
        echo if_ext: $IF
        i=$i+1
      fi
    done
  else
    echo "$ERRMSG1: $F_IF_EXT"
    exit 1
  fi
  if [ ${#IF_EXT[@]} -lt 1 ]; then
    echo "$ERRMSG2: $F_IF_EXT"
    exit 1
  fi
  
  if [ -r $F_IF_INT ]; then
    i=1
    for IF in `cat $F_IF_INT`; do
      if [ -n $IF ]; then
        IF_INT[$i]="$IF"
        echo if_int: $IF
        i=$i+1
      fi
    done
  else
    echo "$ERRMSG1: $F_IF_INT"
    exit 1
  fi
  if [ ${#IF_INT[@]} -lt 1 ]; then
    echo "$ERRMSG2: $F_IF_INT"
    exit 1
  fi

  $IPTABLES -P INPUT DROP
  $IPTABLES -P OUTPUT DROP
  $IPTABLES -P FORWARD DROP

  CH='DENY'
  $IPTABLES -N $CH
  $IPTABLES -A $CH -p tcp -j REJECT --reject-with tcp-reset
  $IPTABLES -A $CH -p udp -j REJECT --reject-with icmp-port-unreachable
  $IPTABLES -A $CH -j DROP

  CH='CHECK'
  $IPTABLES -N $CH
  $IPTABLES -A $CH -p tcp ! --syn -m state --state NEW -j DROP

  CH='BLACKLIST'
  $IPTABLES -N $CH
  for CIDR in `cat $BLACKLIST`; do
    $IPTABLES -A $CH -s $CIDR -j LOG --log-prefix "$CH: "
    $IPTABLES -A $CH -s $CIDR -j DENY
  done

  CH='ULOG_IN'
  $IPTABLES -N $CH
  $IPTABLES -A $CH -j ULOG --ulog-nlgroup 10 --ulog-cprange 20 --ulog-qthreshold 20
  
  CH='ULOG_OUT'
  $IPTABLES -N $CH
  $IPTABLES -A $CH -j ULOG --ulog-nlgroup 20 --ulog-cprange 20 --ulog-qthreshold 20

  CH='INPUT'
  $IPTABLES -A $CH -j CHECK
  $IPTABLES -A $CH -j BLACKLIST
  for IF in lo ${IF_INT[@]}; do
    $IPTABLES -N "$CH"_"$IF"
    $IPTABLES -A "$CH"_"$IF" -j ACCEPT
    $IPTABLES -A $CH -i $IF -j "$CH"_"$IF"
  done
  for IF in ${IF_EXT[@]}; do
    $IPTABLES -N "$CH"_"$IF"
    $IPTABLES -A "$CH"_"$IF" -j ULOG_IN
    $IPTABLES -A "$CH"_"$IF" -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT
    $IPTABLES -A "$CH"_"$IF" -p udp -m state --state ESTABLISHED,RELATED -j ACCEPT
    F=$F_TCP_OK mp
    $IPTABLES -A "$CH"_"$IF" -p tcp -m multiport --dport $MP -j ACCEPT
    F=$F_UDP_OK mp
    $IPTABLES -A "$CH"_"$IF" -p udp -m multiport --dport $MP -j ACCEPT
    $IPTABLES -A "$CH"_"$IF" -p icmp -j ACCEPT
    $IPTABLES -A "$CH"_"$IF" -j LOG --log-prefix "$CH"_"$IF: "
    $IPTABLES -A "$CH"_"$IF" -j DENY
    $IPTABLES -A $CH -i $IF -j "$CH"_"$IF"
  done
  $IPTABLES -A $CH -j LOG --log-prefix "$CH: "
  $IPTABLES -A $CH -j DENY

  CH='OUTPUT'
  $IPTABLES -A $CH -j BLACKLIST
  for IF in lo ${IF_INT[@]}; do
    $IPTABLES -N "$CH"_"$IF"
    $IPTABLES -A "$CH"_"$IF" -j ACCEPT
    $IPTABLES -A $CH -o $IF -j "$CH"_"$IF"
  done
  for IF in ${IF_EXT[@]}; do
    $IPTABLES -N "$CH"_"$IF"
    $IPTABLES -A "$CH"_"$IF" -j ULOG_OUT
    $IPTABLES -A "$CH"_"$IF" -j ACCEPT
    $IPTABLES -A $CH -o $IF -j "$CH"_"$IF"
  done
  $IPTABLES -A $CH -j LOG --log-prefix "$CH: "
  $IPTABLES -A $CH -j DENY

  CH='NOFW'
  $IPTABLES -N $CH
  for CIDR in `cat $NOFW_HARD`; do
    $IPTABLES -A $CH -s $CIDR -j LOG --log-prefix "$CH: "
    $IPTABLES -A $CH -s $CIDR -j DENY
    $IPTABLES -A $CH -d $CIDR -j LOG --log-prefix "$CH: "
    $IPTABLES -A $CH -d $CIDR -j DENY
  done
  for CIDR in `cat $NOFW_SOFT`; do
    F=$F_TCP_NOFW mp
    $IPTABLES -A $CH -s $CIDR -p tcp -m multiport --dport $MP -j LOG --log-prefix "$CH: "
    $IPTABLES -A $CH -s $CIDR -p tcp -m multiport --dport $MP -j DENY
    $IPTABLES -A $CH -d $CIDR -p tcp -m multiport --sport $MP -j LOG --log-prefix "$CH: "
    $IPTABLES -A $CH -d $CIDR -p tcp -m multiport --sport $MP -j DENY
    F=$F_TCP_NOFW mp
    $IPTABLES -A $CH -s $CIDR -p udp -m multiport --dport $MP -j LOG --log-prefix "$CH: "
    $IPTABLES -A $CH -s $CIDR -p udp -m multiport --dport $MP -j DENY
    $IPTABLES -A $CH -d $CIDR -p udp -m multiport --sport $MP -j LOG --log-prefix "$CH: "
    $IPTABLES -A $CH -d $CIDR -p udp -m multiport --sport $MP -j DENY
  done

  CH='FORWARD'
  $IPTABLES -A $CH -j CHECK
  $IPTABLES -A $CH -j BLACKLIST
  for IF in ${IF_INT[@]}; do
    $IPTABLES -N "$CH"_"$IF"
    $IPTABLES -A "$CH"_"$IF" -j NOFW
    for IF_O in ${IF_EXT[@]}; do
      $IPTABLES -A "$CH"_"$IF" -o $IF_O -j ULOG_OUT
    done
    $IPTABLES -A "$CH"_"$IF" -j ACCEPT
    $IPTABLES -A $CH -i $IF -j "$CH"_"$IF"
  done
  for IF in ${IF_EXT[@]}; do
    $IPTABLES -N "$CH"_"$IF"
    $IPTABLES -A "$CH"_"$IF" -j ULOG_IN
    $IPTABLES -A "$CH"_"$IF" -j NOFW
    $IPTABLES -A "$CH"_"$IF" -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT
    $IPTABLES -A "$CH"_"$IF" -p udp -m state --state ESTABLISHED,RELATED -j ACCEPT
    F=$F_TCP_FW mp
    $IPTABLES -A "$CH"_"$IF" -p tcp -m multiport --dport $MP -j ACCEPT
    F=$F_UDP_FW mp
    $IPTABLES -A "$CH"_"$IF" -p udp -m multiport --dport $MP -j ACCEPT
    $IPTABLES -A "$CH"_"$IF" -p icmp -j ACCEPT
    $IPTABLES -A "$CH"_"$IF" -j LOG --log-prefix "$CH"_"$IF: "
    $IPTABLES -A "$CH"_"$IF" -j DENY
    $IPTABLES -A $CH -i $IF -j "$CH"_"$IF"
  done
  $IPTABLES -A $CH -j LOG --log-prefix "$CH: "
  $IPTABLES -A $CH -j DENY

  CH='POSTROUTING'
  if [ -r $F_IF_MASQ ]; then
    for IF in `cat $F_IF_MASQ`; do
      if [ -n $IF ]; then
	$IPTABLES -t nat -A $CH -o $IF -j MASQUERADE
      fi
    done
  fi

}

firewall_stop() {
	$IPTABLES -t filter -F
	$IPTABLES -t filter -X
	$IPTABLES -t filter -Z
	$IPTABLES -t nat -F
	$IPTABLES -t nat -X
	$IPTABLES -t nat -Z
	$IPTABLES -t mangle -F
	$IPTABLES -t mangle -X
	$IPTABLES -t mangle -Z
	$IPTABLES -P INPUT ACCEPT
	$IPTABLES -P OUTPUT ACCEPT
	$IPTABLES -P FORWARD ACCEPT
}

firewall_status() {
	echo "START $DATE"
	$IPTABLES -t filter -vnx -L --line-numbers
	echo "END $DATE"
}

firewall_dump() {
	echo "START $DATE" >> $DUMPFILE
	$IPTABLES -t filter -vnxZ -L --line-numbers >> $DUMPFILE
	echo "END $DATE" >> $DUMPFILE
}

case "$1" in
  start)
	firewall_start
	;;
  stop)
	firewall_stop
	;;
  restart)
	firewall_stop
	firewall_start
	;;
  status)
	firewall_status
  	;;
  dump)
	firewall_dump
  	;;
  *)
	echo "usage: $0 {start|stop|restart|status|dump}" >&2
	exit 1
	;;
esac

exit 0
